<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="CONNECT AXI Chisel Wrapper Documentation (Draft)" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://shili2017.github.io/posts/CONNECT-AXI-CHISEL-DOCS/" /><meta property="og:url" content="https://shili2017.github.io/posts/CONNECT-AXI-CHISEL-DOCS/" /><meta property="og:site_name" content="Li Shi" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-19T21:52:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CONNECT AXI Chisel Wrapper Documentation (Draft)" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-19T21:52:00+00:00","datePublished":"2022-07-19T21:52:00+00:00","description":"Introduction","headline":"CONNECT AXI Chisel Wrapper Documentation (Draft)","mainEntityOfPage":{"@type":"WebPage","@id":"https://shili2017.github.io/posts/CONNECT-AXI-CHISEL-DOCS/"},"url":"https://shili2017.github.io/posts/CONNECT-AXI-CHISEL-DOCS/"}</script><title>CONNECT AXI Chisel Wrapper Documentation (Draft) | Li Shi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Li Shi"><meta name="application-name" content="Li Shi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Li Shi</a></div><div class="site-subtitle font-italic">Sleep every day</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/shili2017" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/lishi2022" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['shili2048','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>CONNECT AXI Chisel Wrapper Documentation (Draft)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>CONNECT AXI Chisel Wrapper Documentation (Draft)</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1658267520" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 19, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/shili2017">Li Shi</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1352 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><p>The AXI4 wrapper is built over the <a href="https://research.ece.cmu.edu/calcm/new_connect/connect/">CONNECT</a> NoC, which is a network generator targeting FPGA. The wrapper supports the following protocols.</p><ul><li><p>AXI4</p><li><p>AXI4-Lite</p><li><p>AXI4-Stream</p><li><p>Simple packet with valid-ready interface</p></ul><h1 id="getting-started">Getting Started</h1><h2 id="build-the-chisel-wrapper"><span class="mr-2">Build The Chisel Wrapper</span><a href="#build-the-chisel-wrapper" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Clone the wrapper repository and build. <code class="language-plaintext highlighter-rouge">PROTOCOL</code> can be <code class="language-plaintext highlighter-rouge">AXI4</code>, <code class="language-plaintext highlighter-rouge">AXI4-Lite</code>, <code class="language-plaintext highlighter-rouge">AXI4-Stream</code> or <code class="language-plaintext highlighter-rouge">Simple</code>. Note that this repository already contains a sample network with 4 send ports and 4 receive ports.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span>git clone https://github.com/shili2017/CONNECT-AXI.git
<span class="nv">$ </span><span class="nb">cd </span>CONNECT-AXI
<span class="nv">$ </span>git submodule update <span class="nt">--init</span> <span class="nt">--recursive</span>
<span class="nv">$ </span>make <span class="nv">PROTOCOL</span><span class="o">=</span>&lt;PROTOCOL&gt;
</pre></table></code></div></div><p>Before using the network, routing tables are required to be created manually, but can also be generated by CONNECT. For example, for the given sample network, create the following four files.</p><ol><li><p><code class="language-plaintext highlighter-rouge">double_ring_4RTs_3VCs_4BD_34DW_SepIFRoundRobinAlloc_routing_0.hex</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> 0
 1
 1
 2
</pre></table></code></div></div><li><p><code class="language-plaintext highlighter-rouge">double_ring_4RTs_3VCs_4BD_34DW_SepIFRoundRobinAlloc_routing_1.hex</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> 2
 0
 1
 1
</pre></table></code></div></div><li><p><code class="language-plaintext highlighter-rouge">double_ring_4RTs_3VCs_4BD_34DW_SepIFRoundRobinAlloc_routing_2.hex</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> 2
 2
 0
 1
</pre></table></code></div></div><li><p><code class="language-plaintext highlighter-rouge">double_ring_4RTs_3VCs_4BD_34DW_SepIFRoundRobinAlloc_routing_3.hex</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> 1
 1
 1
 0
</pre></table></code></div></div></ol><p>Then run the regression test for all the protocols.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>make <span class="nb">test</span>
</pre></table></code></div></div><h2 id="build-the-network-optional"><span class="mr-2">Build The Network (Optional)</span><a href="#build-the-network-optional" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Clone the CONNECT repository and build a network.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>git clone https://github.com/crossroadsfpga/connect.git
<span class="nv">$ </span><span class="nb">cd </span>connect
<span class="nv">$ </span>python gen_network.py <span class="nt">-t</span> double_ring <span class="nt">-w</span> 38 <span class="nt">-n</span> 4 <span class="nt">-v</span> 2 <span class="nt">-d</span> 4 <span class="nt">--gen_rtl</span>
</pre></table></code></div></div><p>The network will be generated and put in the <code class="language-plaintext highlighter-rouge">build</code> directory. To change (a) flit width or (b) number of virtual channels or (c) flit buffer depth, re-generate the network.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python gen_network.py <span class="nt">-t</span> double_ring <span class="nt">-w</span> &lt;flit_width&gt; <span class="nt">-n</span> 4 <span class="nt">-v</span> &lt;num_vcs&gt; <span class="nt">-d</span> &lt;flit_buffer_depth&gt; <span class="nt">--gen_rtl</span>
</pre></table></code></div></div><p>To put the network in the chisel wrapper, remove all redundant files and test bench files, and</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat</span> <span class="k">*</span>.v <span class="o">&gt;</span> network.v
</pre></table></code></div></div><p>Then copy the network into <code class="language-plaintext highlighter-rouge">src/main/resources/vsrc</code> and copy the routing tables with <code class="language-plaintext highlighter-rouge">.hex</code> suffix to the working directory. Also emember to change the corresponding parameters in the chisel wrapper.</p><h1 id="configs">Configs</h1><p>To customize the wrapper, modify the configurations in <code class="language-plaintext highlighter-rouge">Config.scala</code>.</p><h2 id="connect-network-config"><span class="mr-2">CONNECT Network Config</span><a href="#connect-network-config" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>These parameters need to be consistent with the generated CONNECT NoC. AXI4[-Lite] protocol requires at least 3 virtual channels to avoid deadlocks, but there’s no limitations for other protocols.</p><div class="language-scala highlighter-rouge"><div class="code-header"> <span data-label-text="Scala"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ConnectConfig</span>
    <span class="k">extends</span> <span class="nc">Config</span><span class="o">((</span><span class="n">site</span><span class="o">,</span> <span class="n">here</span><span class="o">,</span> <span class="n">up</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">NUM_USER_SEND_PORTS</span>  <span class="k">=&gt;</span> <span class="mi">4</span>
      <span class="k">case</span> <span class="nc">NUM_USER_RECV_PORTS</span>  <span class="k">=&gt;</span> <span class="mi">4</span>
      <span class="k">case</span> <span class="nc">NUM_VCS</span>              <span class="k">=&gt;</span> <span class="mi">3</span>
      <span class="k">case</span> <span class="nc">REAL_FLIT_DATA_WIDTH</span> <span class="k">=&gt;</span> <span class="mi">34</span>
      <span class="k">case</span> <span class="nc">FLIT_BUFFER_DEPTH</span>    <span class="k">=&gt;</span> <span class="mi">4</span>

      <span class="c1">// ...</span>
    <span class="o">})</span>
</pre></table></code></div></div><h2 id="protocol--library-config"><span class="mr-2">Protocol &amp; Library Config</span><a href="#protocol--library-config" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>These parameters can be customized by users.</p><div class="language-scala highlighter-rouge"><div class="code-header"> <span data-label-text="Scala"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">AXI4WrapperConfig</span>
    <span class="k">extends</span> <span class="nc">Config</span><span class="o">((</span><span class="n">site</span><span class="o">,</span> <span class="n">here</span><span class="o">,</span> <span class="n">up</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">PROTOCOL</span>           <span class="k">=&gt;</span> <span class="s">"AXI4"</span>
      <span class="k">case</span> <span class="nc">NUM_MASTER_DEVICES</span> <span class="k">=&gt;</span> <span class="nf">site</span><span class="o">(</span><span class="nc">NUM_USER_SEND_PORTS</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span>
      <span class="k">case</span> <span class="nc">NUM_SLAVE_DEVICES</span>  <span class="k">=&gt;</span> <span class="nf">site</span><span class="o">(</span><span class="nc">NUM_USER_RECV_PORTS</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span>
      <span class="k">case</span> <span class="nc">WRITE_INTERLEAVE</span>   <span class="k">=&gt;</span> <span class="kc">true</span>
      <span class="k">case</span> <span class="nc">AXI4_MAX_BURST_LEN</span> <span class="k">=&gt;</span> <span class="mi">16</span>
    <span class="o">})</span>

<span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">LibraryConfig</span>
    <span class="k">extends</span> <span class="nc">Config</span><span class="o">((</span><span class="n">site</span><span class="o">,</span> <span class="n">here</span><span class="o">,</span> <span class="n">up</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">USE_FIFO_IP</span> <span class="k">=&gt;</span> <span class="kc">true</span>
      <span class="k">case</span> <span class="nc">ALTERA_MF_V</span> <span class="k">=&gt;</span> <span class="s">"/afs/ece.cmu.edu/support/altera/release/pro-19.3.0.222/quartus/eda/sim_lib/altera_mf.v"</span>
    <span class="o">})</span>
</pre></table></code></div></div><h1 id="requiments-on-network">Requiments on Network</h1><p>The Noc in the wrapper can be replaced by another in the future, and the wrapper requires the network to</p><ul><li><p>Support virtual channels for AXI4 and AXI4-Lite (at least 3 VCs)</p><li><p>Maintain in-order transfer between sources and sinks</p><li><p>Be credit-based for flow control</p><li><p>Is possible to convert to a valid-ready flit interface</p></ul><p>However, the network can still</p><ul><li><p>Arbitrarily interleave flits as long as they are in-order</p><li><p>Be in any kind of topology</p><li><p>Support any width of flit data width</p></ul><h1 id="programmers-manual">Programmer’s Manual</h1><p>The overall design is shown in the following diagrams.</p><p><a href="/assets/img/CALCM/CONNECT/D-1.png" class="popup img-link "><img data-src="/assets/img/CALCM/CONNECT/D-1.png" alt="D-1" class="lazyload" data-proofer-ignore></a> <em>AXI4 wrapper block diagram (master device side)</em></p><p><a href="/assets/img/CALCM/CONNECT/D-2.png" class="popup img-link "><img data-src="/assets/img/CALCM/CONNECT/D-2.png" alt="D-2" class="lazyload" data-proofer-ignore></a> <em>AXI4-Stream wrapper block diagram</em></p><h2 id="axi4-stream-bridge"><span class="mr-2">AXI4[-Stream] Bridge</span><a href="#axi4-stream-bridge" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>An AXI4 bridge is used to convert the protocol channels into coressponding packets. For example, for an AXI4 master bridge, it converts 5 AXI4[-Lite] channels into packets in 3 virtual channels (aw/ar channel to <code class="language-plaintext highlighter-rouge">a_packet</code> in VC 2, w channel to <code class="language-plaintext highlighter-rouge">w_packet</code> in VC 1, and b/r channel to <code class="language-plaintext highlighter-rouge">br_packet</code> in VC 0). For an AXI4-Stream master bridge, it converts the t channel into <code class="language-plaintext highlighter-rouge">t_packet</code> and put into VC 0.</p><p>AXI4 bridge is further split into 2 stages. The first stage converts 5 channels into 5 packet outputs, and the second stage contains an arbiter, as shown below. It supports reading and writing at the same time, which are handled by two seprate state machines. The arbiter is set to be round-robin at default.</p><p><a href="/assets/img/CALCM/CONNECT/D-3.png" class="popup img-link "><img data-src="/assets/img/CALCM/CONNECT/D-3.png" alt="D-3" class="lazyload" data-proofer-ignore></a> <em>Two stages of AXI4 master bridge</em></p><p>The original AXI4 protocol doesn’t support transfer-level write interleaving. To support write packet interleaving, set <code class="language-plaintext highlighter-rouge">WRITE_INTERLEAVE</code> to <code class="language-plaintext highlighter-rouge">true</code> and set a proper <code class="language-plaintext highlighter-rouge">AXI4_MAX_BURST_LEN</code>. A write buffer in the slave bridge between stage 1 and stage 2 will be created to handle incoming interleaving write packets and transfer the packets according to current destination.</p><p><a href="/assets/img/CALCM/CONNECT/D-4.png" class="popup img-link "><img data-src="/assets/img/CALCM/CONNECT/D-4.png" alt="D-4" class="lazyload" data-proofer-ignore></a> <em>Write buffer between stage 1 and 2 to store interleaving write packets</em></p><p>Parameters of AXI4[-Stream] protocol can be adjusted in <code class="language-plaintext highlighter-rouge">AXI4.scala</code>. Each AXI4[-Stream] request and response is encoded in a single AXI4[-Stream] packet, or the packet can be decoded to be an AXI4[-Stream] request or response, related functions in <code class="language-plaintext highlighter-rouge">AXI4Packet.scala</code>. For example, the following code snippet shows the encoding and decoding of AXI4 or AXI4-Lite write channel packet.</p><div class="language-scala highlighter-rouge"><div class="code-header"> <span data-label-text="Scala"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="c1">// Encode</span>
<span class="k">object</span> <span class="nc">AXI4ChannelW2PacketData</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="o">[</span><span class="kt">C</span> <span class="k">&lt;:</span> <span class="kt">AXI4LiteChannelW</span><span class="o">](</span><span class="n">w</span><span class="k">:</span> <span class="kt">C</span><span class="o">)</span><span class="k">:</span> <span class="kt">UInt</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">w</span><span class="o">.</span><span class="py">getClass</span> <span class="o">==</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">AXI4ChannelW</span><span class="o">])</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">w_</span> <span class="k">=</span> <span class="nv">w</span><span class="o">.</span><span class="py">asInstanceOf</span><span class="o">[</span><span class="kt">AXI4ChannelW</span><span class="o">]</span>
      <span class="nc">Cat</span><span class="o">(</span>
        <span class="nv">w_</span><span class="o">.</span><span class="py">strb</span><span class="o">,</span>
        <span class="nv">w_</span><span class="o">.</span><span class="py">data</span><span class="o">,</span>
        <span class="nv">w_</span><span class="o">.</span><span class="py">last</span><span class="o">.</span><span class="py">asUInt</span><span class="o">,</span>
        <span class="nv">AXI4ChannelID</span><span class="o">.</span><span class="py">W</span>
      <span class="o">)</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nc">Cat</span><span class="o">(</span>
        <span class="nv">w</span><span class="o">.</span><span class="py">strb</span><span class="o">,</span>
        <span class="nv">w</span><span class="o">.</span><span class="py">data</span><span class="o">,</span>
        <span class="nv">AXI4ChannelID</span><span class="o">.</span><span class="py">W</span>
      <span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Decode</span>
<span class="k">object</span> <span class="nc">Packet2AXI4ChannelW</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="o">(</span><span class="n">packet</span><span class="k">:</span> <span class="kt">UInt</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Parameters</span><span class="o">)</span><span class="k">:</span> <span class="kt">AXI4LiteChannelW</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">assert</span><span class="o">(</span><span class="nv">packet</span><span class="o">.</span><span class="py">getWidth</span> <span class="o">==</span> <span class="nf">p</span><span class="o">(</span><span class="nc">PACKET_WIDTH</span><span class="o">))</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nf">p</span><span class="o">(</span><span class="nc">PROTOCOL</span><span class="o">)</span> <span class="o">==</span> <span class="s">"AXI4"</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">w</span> <span class="k">=</span> <span class="nc">Wire</span><span class="o">(</span><span class="k">new</span> <span class="nc">AXI4ChannelW</span><span class="o">)</span>
      <span class="nv">w</span><span class="o">.</span><span class="py">strb</span> <span class="o">:=</span> <span class="nf">packet</span><span class="o">(</span>
        <span class="mi">3</span> <span class="o">+</span> <span class="nv">AXI4Parameters</span><span class="o">.</span><span class="py">AXI4DataWidth</span> <span class="o">+</span> <span class="nv">AXI4Parameters</span><span class="o">.</span><span class="py">AXI4DataWidth</span> <span class="o">/</span> <span class="mi">8</span><span class="o">,</span>
        <span class="mi">4</span> <span class="o">+</span> <span class="nv">AXI4Parameters</span><span class="o">.</span><span class="py">AXI4DataWidth</span>
      <span class="o">)</span>
      <span class="nv">w</span><span class="o">.</span><span class="py">data</span> <span class="o">:=</span> <span class="nf">packet</span><span class="o">(</span><span class="mi">3</span> <span class="o">+</span> <span class="nv">AXI4Parameters</span><span class="o">.</span><span class="py">AXI4DataWidth</span><span class="o">,</span> <span class="mi">4</span><span class="o">)</span>
      <span class="nv">w</span><span class="o">.</span><span class="py">last</span> <span class="o">:=</span> <span class="nf">packet</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="py">asBool</span>
      <span class="n">w</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">w</span> <span class="k">=</span> <span class="nc">Wire</span><span class="o">(</span><span class="k">new</span> <span class="nc">AXI4LiteChannelW</span><span class="o">)</span>
      <span class="nv">w</span><span class="o">.</span><span class="py">strb</span> <span class="o">:=</span> <span class="nf">packet</span><span class="o">(</span>
        <span class="mi">2</span> <span class="o">+</span> <span class="nv">AXI4Parameters</span><span class="o">.</span><span class="py">AXI4DataWidth</span> <span class="o">+</span> <span class="nv">AXI4Parameters</span><span class="o">.</span><span class="py">AXI4DataWidth</span> <span class="o">/</span> <span class="mi">8</span><span class="o">,</span>
        <span class="mi">3</span> <span class="o">+</span> <span class="nv">AXI4Parameters</span><span class="o">.</span><span class="py">AXI4DataWidth</span>
      <span class="o">)</span>
      <span class="nv">w</span><span class="o">.</span><span class="py">data</span> <span class="o">:=</span> <span class="nf">packet</span><span class="o">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">AXI4Parameters</span><span class="o">.</span><span class="py">AXI4DataWidth</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
      <span class="n">w</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="serializer--deserializer"><span class="mr-2">Serializer &amp; Deserializer</span><a href="#serializer--deserializer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Usually the size of AXI4 protocol packets or customized user packets is larger than flit data width. In such circumstance, we need a serializer and deserializer to convert between large packets and small flits. A serializer cuts a packet into small flits with the user-defined size and send to the network, while a deserializer receives flits from the network and reassembles to packets and send to the user device.</p><p>In the case that multiple master devices send data to a single slave device, flits that arrives at the deserializer may interleave when virtual link is disabled in CONNECT network or in other NoCs. As the flits are always transferred in-order, and we know the number of send ports, we simply allocate a table with one row per source ID and fill the table with successive flits until the tail flit arrives, at which the flits are reassembled into a packet. If packets from multiple sources are ready, a priority encoder is implemented to decide which packet to send to output.</p><p>If Intel FIFO IP exists, user may set <code class="language-plaintext highlighter-rouge">USE_FIFO_IP</code> to <code class="language-plaintext highlighter-rouge">true</code> and set the corresponding library path. A <code class="language-plaintext highlighter-rouge">dcfifo</code> will be created in the serializer and deserializer, acting as the boundary of slow clock domain for FPGA logics and fast clock domain for hard NoC.</p><h2 id="flow-control-layer"><span class="mr-2">Flow Control Layer</span><a href="#flow-control-layer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Credit-based flow control is supported in CONNECT and the wrapper. To support flow control, a synchronous FIFO, e.g., <code class="language-plaintext highlighter-rouge">SCFIFO</code> or chisel queue, is included as a buffer in each virtual channel between the user device and the network. On the sender side, we need to maintain a credit counter. Each time we send a flit, we need to decrement the counter, and each time we receive a credit from the network, we increment the counter. On the receiver side, each time we dequeue a flit from the FIFO to the user device, we send a credit to the network. After the FIFO, we implement a N-to-1 hub on the sender side and a 1-to-N hub on the receiver side. Finally a send/recv port interface converter is implemented to convert valid-ready interface into BSV-style interface.</p><p><a href="/assets/img/CALCM/CONNECT/D-5.png" class="popup img-link "><img data-src="/assets/img/CALCM/CONNECT/D-5.png" alt="D-5" class="lazyload" data-proofer-ignore></a> <em>Flow control layer on the sender side with 3 virtual channels</em></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/calcm/'>CALCM</a>, <a href='/categories/connect/'>CONNECT</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=CONNECT%20AXI%20Chisel%20Wrapper%20Documentation%20(Draft)%20-%20Li%20Shi&url=https%3A%2F%2Fshili2017.github.io%2Fposts%2FCONNECT-AXI-CHISEL-DOCS%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=CONNECT%20AXI%20Chisel%20Wrapper%20Documentation%20(Draft)%20-%20Li%20Shi&u=https%3A%2F%2Fshili2017.github.io%2Fposts%2FCONNECT-AXI-CHISEL-DOCS%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fshili2017.github.io%2Fposts%2FCONNECT-AXI-CHISEL-DOCS%2F&text=CONNECT%20AXI%20Chisel%20Wrapper%20Documentation%20(Draft)%20-%20Li%20Shi" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fshili2017.github.io%2Fposts%2FCONNECT-AXI-CHISEL-DOCS%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=CONNECT%20AXI%20Chisel%20Wrapper%20Documentation%20(Draft)%20-%20Li%20Shi&url=https%3A%2F%2Fshili2017.github.io%2Fposts%2FCONNECT-AXI-CHISEL-DOCS%2F" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/BOOKS/">2023年读书记录</a><li><a href="/posts/NOC5/">《片上网络》笔记（五）：流量控制</a><li><a href="/posts/MCCC9/">《内存一致性与缓存一致性》笔记（九）：异构系统的内存一致性与缓存一致性</a><li><a href="/posts/RL4/">CMU 18-643可重构计算笔记-4：类C语言硬件综合的挑战</a><li><a href="/posts/RL1/">CMU 18-643可重构计算笔记-1：FPGA的三个时代</a></ul></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/CONNECT1/"><div class="card-body"> <em class="small" data-ts="1653579120" data-df="ll" > May 26, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CONNECT Note (1) - Paper</h3><div class="text-muted small"><p> 原文：CONNECT: Re-Examining Conventional Wisdom for Designing NoCs in the Context of FPGAs. CONNECT是一个NoC生成器，面向FPGA生成任意多节点拓扑结构的可综合RTL设计，这里有一个online demo。CONNECT的意义在于，传统的NoC设计都为ASIC优化，但是面向FPGA的NoC设计需要...</p></div></div></a></div><div class="card"> <a href="/posts/CONNECT2/"><div class="card-body"> <em class="small" data-ts="1654046820" data-df="ll" > Jun 1, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CONNECT Note (2) - Setup</h3><div class="text-muted small"><p> Run CONNECT testbench Thank Siddharth for providing the notes! Clone the repository from Crossroads GitHub To build a basic double ring network with 4 ports, 256 bit flits, 2 vi...</p></div></div></a></div><div class="card"> <a href="/posts/CONNECT3/"><div class="card-body"> <em class="small" data-ts="1654139220" data-df="ll" > Jun 2, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CONNECT Note (3) - AXI4 Interface</h3><div class="text-muted small"><p> Source code: link. AXI Requests &amp;amp; Responses In Flits Signals in 5 channels are encapsulated in flit data, with following parameters. parameter ADDR_WIDTH = 32; parameter DATA_WIDTH = 64;...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/CONNECT7/" class="btn btn-outline-primary" prompt="Older"><p>CONNECT Note (7) - So... why Chisel?</p></a> <a href="/posts/MCCC7/" class="btn btn-outline-primary" prompt="Newer"><p>《内存一致性与缓存一致性》笔记（七）：总线嗅探一致性协议</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/shili2017">Li Shi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
