<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="《片上网络》笔记（六）：路由器微架构" /><meta property="og:locale" content="en" /><meta name="description" content="路由器的设计必须在严格的面积和功率限制下满足延迟和吞吐量的要求，这也是在多核系统扩展时面临的一个主要挑战。对吞吐量要求较低时，可以使用非常简单的路由器，其面积和功率开销较低，但是当NoC的延迟和吞吐量要求提高时，就会对路由器设计提出挑战。" /><meta property="og:description" content="路由器的设计必须在严格的面积和功率限制下满足延迟和吞吐量的要求，这也是在多核系统扩展时面临的一个主要挑战。对吞吐量要求较低时，可以使用非常简单的路由器，其面积和功率开销较低，但是当NoC的延迟和吞吐量要求提高时，就会对路由器设计提出挑战。" /><link rel="canonical" href="https://shili2017.github.io/posts/NOC6/" /><meta property="og:url" content="https://shili2017.github.io/posts/NOC6/" /><meta property="og:site_name" content="Li Shi" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-26T00:32:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="《片上网络》笔记（六）：路由器微架构" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-26T00:32:00+00:00","datePublished":"2022-05-26T00:32:00+00:00","description":"路由器的设计必须在严格的面积和功率限制下满足延迟和吞吐量的要求，这也是在多核系统扩展时面临的一个主要挑战。对吞吐量要求较低时，可以使用非常简单的路由器，其面积和功率开销较低，但是当NoC的延迟和吞吐量要求提高时，就会对路由器设计提出挑战。","headline":"《片上网络》笔记（六）：路由器微架构","mainEntityOfPage":{"@type":"WebPage","@id":"https://shili2017.github.io/posts/NOC6/"},"url":"https://shili2017.github.io/posts/NOC6/"}</script><title>《片上网络》笔记（六）：路由器微架构 | Li Shi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Li Shi"><meta name="application-name" content="Li Shi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Li Shi</a></div><div class="site-subtitle font-italic">Sleep every day</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/shili2017" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/lishi2022" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['shili2048','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>《片上网络》笔记（六）：路由器微架构</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>《片上网络》笔记（六）：路由器微架构</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1653525120" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 26, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/shili2017">Li Shi</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2092 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><p>路由器的设计必须在严格的面积和功率限制下满足延迟和吞吐量的要求，这也是在多核系统扩展时面临的一个主要挑战。对吞吐量要求较低时，可以使用非常简单的路由器，其面积和功率开销较低，但是当NoC的延迟和吞吐量要求提高时，就会对路由器设计提出挑战。</p><p>路由器的微架构决定了关键路径延迟，影响每一跳以及整个网络的延迟。路由的实现、流量控制和实际的路由器流水线会影响到使用缓冲区和链接的效率，从而影响到整个网络的吞吐量。路由器的微架构也会影响网络功耗（包括动态和静态）和面积占用。</p><h2 id="虚拟通道路由器微架构"><span class="mr-2">虚拟通道路由器微架构</span><a href="#虚拟通道路由器微架构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="/assets/img/Book/NOC/6-1.png" class="popup img-link "><img data-src="/assets/img/Book/NOC/6-1.png" alt="6-1" class="lazyload" data-proofer-ignore></a> <em>基于信用的VC路由器微架构</em></p><p>上图展示了基于信用的VC路由器微架构，以解释典型路由器的工作原理。在这个例子中，我们假设有一个2-D Mesh结构，每个路由器有5个输入和输出端口，分别对应4个相邻方向以及一个本地处理器端口，每个输入端口有4个VC，每个VC都有自己的缓冲队列，队列深度为4 flits。</p><p>构成路由器的主要部件是输入缓冲、路由计算逻辑、虚拟通道分配器、开关分配器和crossbar开关。如果不使用源节点路由，路由计算器将计算（或查找）当前数据包的输出端口，分配器决定哪些flits被选择进入下一个阶段，并穿越crossbar，最后crossbar负责将flits从输入端口物理地移动到输出端口。</p><h2 id="缓冲区和虚拟通道"><span class="mr-2">缓冲区和虚拟通道</span><a href="#缓冲区和虚拟通道" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>当数据包或flits不能立即转发到输出时，会被存放在缓冲区中，可以在输入端口和输出端口上进行缓冲。当交换机的分配速率大于通道的传输速率时，就需要输出缓冲。</p><h3 id="缓冲区组织结构"><span class="mr-2">缓冲区组织结构</span><a href="#缓冲区组织结构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/img/Book/NOC/6-2.png" class="popup img-link "><img data-src="/assets/img/Book/NOC/6-2.png" alt="6-2" class="lazyload" data-proofer-ignore></a> <em>缓冲区与VC组织结构</em></p><p>缓冲区组织结构会很大程度上影响网络吞吐量，具体的设计有：单个固定长度的队列、多个固定长度的队列（每个队列被称为虚拟通道，复用并共享物理通道或带宽）、多个可变长度的队列（多个VC共享一个大的缓冲区，但电路更复杂，且需要为每个VC保留一定大小以避免死锁）、最小数量的虚拟通道、最小缓冲区数量。</p><h3 id="输入vc状态"><span class="mr-2">输入VC状态</span><a href="#输入vc状态" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>每个VC都和其中flit的以下状态有关：</p><ol><li><p>Global (G): Idle/Routing/waiting for output VC/waiting for credits in output VC/Active. Active VCs can perform switch allocation.</p><li><p>Route (R): Output port for the packet. This field is used for switch allocation. The output port is populated after route computation by the head flit. In designs with lookahead routing or source routing, the head flit arrives at the current router with the output port already designated.</p><li><p>Output VC (O): Output VC (i.e., VC at downstream router) for this packet. This is populated after VC allocation by the head flit, and used by all subsequent flits in the packet.</p><li><p>Credit Count (C): Number of credits (i.e., flit buffers at downstream router) in output VC O at output port R. This field is used by body and tail flits.</p><li><p>Pointers (P): Pointers to head and tail flits. This is required if buffers are implemented as a shared pool of multiple variable-length queues, as described above.</p></ol><h2 id="开关设计"><span class="mr-2">开关设计</span><a href="#开关设计" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>路由器的crossbar开关是路由器数据通路的核心部分，将数据从输入端口移动到输出端口。</p><h3 id="crossbar设计"><span class="mr-2">Crossbar设计</span><a href="#crossbar设计" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/img/Book/NOC/6-3.png" class="popup img-link "><img data-src="/assets/img/Book/NOC/6-3.png" alt="6-3" class="lazyload" data-proofer-ignore></a></p><p>下面给出了一个基本的描述Crossbar开关的Verilog模块，如上图所示，大多数低频路由器使用这种crossbar。</p><div class="language-verilog highlighter-rouge"><div class="code-header"> <span data-label-text="Verilog"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">module</span> <span class="n">xbar</span> <span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="n">in0</span><span class="p">,</span> <span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">in3</span><span class="p">,</span> <span class="n">in4</span><span class="p">,</span> <span class="n">out0</span><span class="p">,</span> <span class="n">out1</span><span class="p">,</span> <span class="n">out2</span> <span class="n">out3</span><span class="p">,</span> <span class="n">out4</span><span class="p">,</span> <span class="n">colsel0</span><span class="p">,</span> <span class="n">colsel1</span><span class="p">,</span><span class="n">colsel2</span><span class="p">,</span> <span class="n">colsel3</span><span class="p">,</span> <span class="n">colsel4</span><span class="p">);</span>

  <span class="kt">input</span> <span class="n">clk</span><span class="p">;</span>
  <span class="kt">input</span> <span class="n">reset</span><span class="p">;</span>
  <span class="kt">input</span> <span class="p">[</span><span class="err">'</span><span class="n">CHANNELWIDTH</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">in0</span><span class="p">,</span> <span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">in3</span><span class="p">,</span> <span class="n">in4</span><span class="p">;</span>
  <span class="kt">output</span> <span class="p">[</span><span class="err">'</span><span class="n">CHANNELWIDTH</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">out0</span><span class="p">,</span> <span class="n">out1</span><span class="p">,</span> <span class="n">out2</span><span class="p">,</span> <span class="n">out3</span><span class="p">,</span> <span class="n">out4</span><span class="p">;</span>
  <span class="kt">input</span> <span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">colsel0</span><span class="p">,</span> <span class="n">colsel1</span><span class="p">,</span> <span class="n">colsel2</span><span class="p">,</span> <span class="n">colsel3</span> <span class="n">colsel4</span><span class="p">;</span>
  <span class="kt">reg</span> <span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">colsel0reg</span><span class="p">,</span> <span class="n">colsel1reg</span><span class="p">,</span> <span class="n">colsel2reg</span><span class="p">,</span> <span class="n">colsel3reg</span><span class="p">,</span> <span class="n">colsel4reg</span><span class="p">;</span>

  <span class="n">bitxbar</span> <span class="n">bx0</span><span class="p">(</span><span class="n">in0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">in1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">in2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">in3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">in4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">out0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">out1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">out2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">out3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">out4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">colsel0reg</span><span class="p">,</span><span class="n">colsel1reg</span><span class="p">,</span><span class="n">colsel2reg</span><span class="p">,</span><span class="n">colsel3reg</span><span class="p">,</span><span class="n">colsel4reg</span><span class="p">,</span><span class="mb">1'bx</span><span class="p">);</span>
  <span class="n">bitxbar</span> <span class="n">bx1</span><span class="p">(</span><span class="n">in0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">in1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">in2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">in3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">in4</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">out0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">out1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">out2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">out3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">out4</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">colsel0reg</span><span class="p">,</span><span class="n">colsel1reg</span><span class="p">,</span><span class="n">colsel2reg</span><span class="p">,</span><span class="n">colsel3reg</span><span class="p">,</span><span class="n">colsel4reg</span><span class="p">,</span><span class="mb">1'bx</span><span class="p">);</span>
  <span class="n">bitxbar</span> <span class="n">bx2</span><span class="p">(</span><span class="n">in0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">in1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">in2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">in3</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">in4</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">out0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">out1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">out2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">out3</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">out4</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">colsel0reg</span><span class="p">,</span><span class="n">colsel1reg</span><span class="p">,</span><span class="n">colsel2reg</span><span class="p">,</span><span class="n">colsel3reg</span><span class="p">,</span><span class="n">colsel4reg</span><span class="p">,</span><span class="mb">1'bx</span><span class="p">);</span>
  <span class="n">bitxbar</span> <span class="n">bx3</span><span class="p">(</span><span class="n">in0</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">in1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">in2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">in3</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">in4</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">out0</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">out1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">out2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">out3</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">out4</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">colsel0reg</span><span class="p">,</span><span class="n">colsel1reg</span><span class="p">,</span><span class="n">colsel2reg</span><span class="p">,</span><span class="n">colsel3reg</span><span class="p">,</span><span class="n">colsel4reg</span><span class="p">,</span><span class="mb">1'bx</span><span class="p">);</span>

<span class="k">endmodule</span>
</pre></table></code></div></div><div class="language-verilog highlighter-rouge"><div class="code-header"> <span data-label-text="Verilog"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">module</span> <span class="n">bitxbar</span> <span class="p">(</span><span class="n">i0</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">i3</span><span class="p">,</span><span class="n">i4</span><span class="p">,</span><span class="n">o0</span><span class="p">,</span><span class="n">o1</span><span class="p">,</span><span class="n">o2</span><span class="p">,</span><span class="n">o3</span><span class="p">,</span><span class="n">o4</span><span class="p">,</span><span class="n">sel0</span><span class="p">,</span><span class="n">sel1</span><span class="p">,</span><span class="n">sel2</span><span class="p">,</span><span class="n">sel3</span><span class="p">,</span><span class="n">sel4</span><span class="p">,</span><span class="n">inv</span><span class="p">);</span>

  <span class="kt">input</span> <span class="n">i0</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">i3</span><span class="p">,</span><span class="n">i4</span><span class="p">;</span>
  <span class="kt">output</span> <span class="n">o0</span><span class="p">,</span><span class="n">o1</span><span class="p">,</span><span class="n">o2</span><span class="p">,</span><span class="n">o3</span><span class="p">,</span><span class="n">o4</span><span class="p">;</span>
  <span class="kt">input</span> <span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">sel0</span><span class="p">,</span> <span class="n">sel1</span><span class="p">,</span> <span class="n">sel2</span><span class="p">,</span> <span class="n">sel3</span><span class="p">,</span> <span class="n">sel4</span><span class="p">;</span>
  <span class="kt">input</span> <span class="n">inv</span><span class="p">;</span>
  <span class="kt">buf</span> <span class="n">b0</span><span class="p">(</span><span class="n">i00</span><span class="p">,</span> <span class="n">i0</span><span class="p">);</span> <span class="c1">// buffer for driving in0 to the 5 muxes</span>
  <span class="c1">// ...</span>
  <span class="kt">buf</span> <span class="n">b4</span><span class="p">(</span><span class="n">i40</span><span class="p">,</span> <span class="n">i4</span><span class="p">);</span>

  <span class="n">mux5_1</span> <span class="n">m0</span><span class="p">(</span><span class="n">i00</span><span class="p">,</span> <span class="n">i10</span><span class="p">,</span> <span class="n">i20</span><span class="p">,</span> <span class="n">i30</span><span class="p">,</span> <span class="n">i40</span><span class="p">,</span> <span class="n">o0</span><span class="p">,</span> <span class="n">sel0</span><span class="p">,</span> <span class="n">inv</span><span class="p">);</span>
  <span class="c1">// ...</span>
  <span class="n">mux5_1</span> <span class="n">m4</span><span class="p">(</span><span class="n">i00</span><span class="p">,</span> <span class="n">i10</span><span class="p">,</span> <span class="n">i20</span><span class="p">,</span> <span class="n">i30</span><span class="p">,</span> <span class="n">i40</span><span class="p">,</span> <span class="n">o4</span><span class="p">,</span> <span class="n">sel4</span><span class="p">,</span> <span class="n">inv</span><span class="p">);</span>

<span class="k">endmodule</span>
</pre></table></code></div></div><p>当频率要求更高时，会采用下图所示的设计，但无论采用哪种设计，面积和功率都会以O((pw)^2)的复杂度增长，其中p是crossbar端口的数量，w是端口宽度（单位bit）。</p><p><a href="/assets/img/Book/NOC/6-4.png" class="popup img-link "><img data-src="/assets/img/Book/NOC/6-4.png" alt="6-4" class="lazyload" data-proofer-ignore></a> <em>一个5x5的crossbar开关</em></p><h2 id="分配器与仲裁器"><span class="mr-2">分配器与仲裁器</span><a href="#分配器与仲裁器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>一个分配器将N个请求与M个资源相匹配，而一个仲裁器将N个请求与1个资源相匹配。对路由器来说，资源是VC和crossbar开关的端口。在多个VC的路由器中，我们需要一个VC分配器（VA）以及一个交换机分配器（SA），前者将VC分配给数据包或flit，或者将crossbar端口分配给VC。一个能提供高匹配概率的分配器或仲裁器可以使更多包顺利获得VC并通过crossbar，提高网络吞吐量。在大多数NoC中，路由器的分配逻辑决定了周期时间，因此分配器和仲裁器必须是快速的，并且是流水线的，以便在高时钟频率下工作。</p><h3 id="循环round-robin仲裁器"><span class="mr-2">循环（Round-robin）仲裁器</span><a href="#循环round-robin仲裁器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/img/Book/NOC/6-5.png" class="popup img-link "><img data-src="/assets/img/Book/NOC/6-5.png" alt="6-5" class="lazyload" data-proofer-ignore></a> <em>循环仲裁器</em></p><h3 id="矩阵仲裁器"><span class="mr-2">矩阵仲裁器</span><a href="#矩阵仲裁器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/img/Book/NOC/6-6.png" class="popup img-link "><img data-src="/assets/img/Book/NOC/6-6.png" alt="6-6" class="lazyload" data-proofer-ignore></a> <em>矩阵仲裁器，其中wij表示优先位，当wij为1时，请求i的优先级比请求j更高</em></p><h3 id="分离式分配器"><span class="mr-2">分离式分配器</span><a href="#分离式分配器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>为了降低分配器的复杂度，并使其流水化，分配器可以被构建为多个仲裁器的组合。在实践中尝试了不同的仲裁器，其中循环仲裁器由于其实现简单而最受欢迎。</p><p><a href="/assets/img/Book/NOC/6-7.png" class="popup img-link "><img data-src="/assets/img/Book/NOC/6-7.png" alt="6-7" class="lazyload" data-proofer-ignore></a> <em>一个分离式的3:4分配器（3个请求者、4个资源）</em></p><h2 id="流水线"><span class="mr-2">流水线</span><a href="#流水线" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="/assets/img/Book/NOC/6-8.png" class="popup img-link "><img data-src="/assets/img/Book/NOC/6-8.png" alt="6-8" class="lazyload" data-proofer-ignore></a> <em>路由器流水线 (BW: Buffer Write, RC: Route Computation, VA: Virtual Channel Allocation, SA: Switch Allocation, ST: Switch Traversal, LT: Link Traversal)</em></p><p>上图a显示了一个基本的VC路由器的逻辑流水线阶段。head flit到达一个输入端口时，首先根据其输入的VC在BW级进行解码并放入缓冲区，接下来在RC级路由逻辑进行计算以确定包的输出端口，然后head flit在VA级进行仲裁，找到输出端口的VC（即下一个路由器输入端口的VC），成功分配VC后，head flit进入SA级，对switch的输入和输出端口进行仲裁，随后进入ST级，遍历crossbar，最后在LT级，该flit被传送到下一个节点。body和tail flit遵循类似的流水线，但不会经过RC和VA级，而是直接继承header flit分配的路由和VC，tail flit在离开路由器时，会移除head flit保留的VC。</p><h3 id="实现与优化"><span class="mr-2">实现与优化</span><a href="#实现与优化" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>最长关键路径延迟的流水线级决定了时钟频率，通常当VC较多或crossbar较复杂时，VA或SA级的延迟最长。增加流水线级数会增加消息在每一跳的延迟，以及影响所需的最小缓冲区大小和吞吐量的缓冲区周转时间，因此有必要对其进行优化。</p><p>提前路由（lookahead routing）流水线移除了RC级，数据包的路由是由提前一跳确定的，并在head flit中编码，如上图b。低负载旁路（low-load bypass）流水线在轻度负载的路由器中移除了BW和SA级，如上图c。推测性VA移除了VA级，flit在BW之后推测性地进入SA级，对switch端口进行仲裁，并试图获得一个空闲的VC，如上图d。提前旁路（lookahead bypass）移除了BW和SA级，如上图e。具体的优化技巧相对而言比较复杂，可以参考原文。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/'>读书笔记</a>, <a href='/categories/%E7%89%87%E4%B8%8A%E7%BD%91%E7%BB%9C/'>片上网络</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E3%80%8A%E7%89%87%E4%B8%8A%E7%BD%91%E7%BB%9C%E3%80%8B%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%EF%BC%89%EF%BC%9A%E8%B7%AF%E7%94%B1%E5%99%A8%E5%BE%AE%E6%9E%B6%E6%9E%84%20-%20Li%20Shi&url=https%3A%2F%2Fshili2017.github.io%2Fposts%2FNOC6%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E3%80%8A%E7%89%87%E4%B8%8A%E7%BD%91%E7%BB%9C%E3%80%8B%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%EF%BC%89%EF%BC%9A%E8%B7%AF%E7%94%B1%E5%99%A8%E5%BE%AE%E6%9E%B6%E6%9E%84%20-%20Li%20Shi&u=https%3A%2F%2Fshili2017.github.io%2Fposts%2FNOC6%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fshili2017.github.io%2Fposts%2FNOC6%2F&text=%E3%80%8A%E7%89%87%E4%B8%8A%E7%BD%91%E7%BB%9C%E3%80%8B%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%EF%BC%89%EF%BC%9A%E8%B7%AF%E7%94%B1%E5%99%A8%E5%BE%AE%E6%9E%B6%E6%9E%84%20-%20Li%20Shi" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fshili2017.github.io%2Fposts%2FNOC6%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=%E3%80%8A%E7%89%87%E4%B8%8A%E7%BD%91%E7%BB%9C%E3%80%8B%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%EF%BC%89%EF%BC%9A%E8%B7%AF%E7%94%B1%E5%99%A8%E5%BE%AE%E6%9E%B6%E6%9E%84%20-%20Li%20Shi&url=https%3A%2F%2Fshili2017.github.io%2Fposts%2FNOC6%2F" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/BOOKS/">2023年读书记录</a><li><a href="/posts/NOC5/">《片上网络》笔记（五）：流量控制</a><li><a href="/posts/MCCC9/">《内存一致性与缓存一致性》笔记（九）：异构系统的内存一致性与缓存一致性</a><li><a href="/posts/RL4/">CMU 18-643可重构计算笔记-4：类C语言硬件综合的挑战</a><li><a href="/posts/RL1/">CMU 18-643可重构计算笔记-1：FPGA的三个时代</a></ul></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/NOC1/"><div class="card-body"> <em class="small" data-ts="1652288880" data-df="ll" > May 11, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>《片上网络》笔记（一）：基础</h3><div class="text-muted small"><p> 《片上网络》原书英文名为 On-Chip Networks，和《处理器微架构实现》一样隶属于Synthesis Lectures on Computer Architecture系列，简单介绍了片上网络设计的一些关键概念。 按照维基百科的描述，片上网络（NoC）是一种基于传统计算机网络概念的通信系统电路，最常见于SoC的各个模块之间，NoC技术将计算机网络的理论和方法应用于片上通信，提高了...</p></div></div></a></div><div class="card"> <a href="/posts/NOC2/"><div class="card-body"> <em class="small" data-ts="1652842800" data-df="ll" > May 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>《片上网络》笔记（二）：系统架构与接口</h3><div class="text-muted small"><p> 在这一章中我们研究三种主要的系统架构：共享内存芯片多处理器（shared-memory chip multiprocessor, CMP）、消息传递系统、多处理器SoC（multiprocessor SoC, MPSoC）。 共享内存CMP 并行编程中，一个全局的地址空间通常比分区的地址空间设计起来更简单。在现代SMP设计中，分区全局地址空间（partitioned global add...</p></div></div></a></div><div class="card"> <a href="/posts/NOC3/"><div class="card-body"> <em class="small" data-ts="1653088140" data-df="ll" > May 20, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>《片上网络》笔记（三）：拓扑结构</h3><div class="text-muted small"><p> NoC的拓扑结构决定了网络中节点和通道之间的物理布局和连接，直接决定了消息的跳数（hops）、节点之间的距离、网络延迟、能耗、如何分散路径等。最简单的拓扑结构之一是总线，总线上每个信号都可以被所有总线上的设备观察到，但可扩展性差，带宽有限。 指标 我们在设计NoC时第一个做出的决定往往是对拓扑结构的选择，因此在网络的其他元素确定之前，有一种快速比较不同的拓扑结构的方法是非常有用的。下图展...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Pigasus1/" class="btn btn-outline-primary" prompt="Older"><p>Pigasus笔记：Zhipeng Zhao的PhD Thesis</p></a> <a href="/posts/CONNECT1/" class="btn btn-outline-primary" prompt="Newer"><p>CONNECT Note (1) - Paper</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/shili2017">Li Shi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
